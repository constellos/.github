name: Code Reviews

# Reusable workflow for all Claude Code review types
# Runs reviews and posts consolidated comment to PR

on:
  workflow_call:
    inputs:
      requirements_review:
        description: 'Enable requirements review'
        type: boolean
        default: true
      rules_review:
        description: 'Enable rules review'
        type: boolean
        default: true
      project_memory_review:
        description: 'Enable project memory review'
        type: boolean
        default: true
      agents_review:
        description: 'Enable agents review'
        type: boolean
        default: true
      skills_review:
        description: 'Enable skills review'
        type: boolean
        default: true
      playwright_ui_review:
        description: 'Enable Playwright UI review'
        type: boolean
        default: false
      screenshot_artifact:
        description: 'Name of screenshot artifact (for UI review)'
        type: string
        default: ''
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true
    outputs:
      all_passed:
        description: 'Whether all enabled reviews passed'
        value: ${{ jobs.summary.outputs.all_passed }}
      requirements_passed:
        description: 'Requirements review result'
        value: ${{ jobs.reviews.outputs.requirements_passed }}
      rules_passed:
        description: 'Rules review result'
        value: ${{ jobs.reviews.outputs.rules_passed }}
      project_memory_passed:
        description: 'Project memory review result'
        value: ${{ jobs.reviews.outputs.project_memory_passed }}
      agents_passed:
        description: 'Agents review result'
        value: ${{ jobs.reviews.outputs.agents_passed }}
      skills_passed:
        description: 'Skills review result'
        value: ${{ jobs.reviews.outputs.skills_passed }}
      ui_passed:
        description: 'UI review result'
        value: ${{ jobs.reviews.outputs.ui_passed }}

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

jobs:
  reviews:
    name: Run Reviews
    runs-on: ubuntu-latest
    outputs:
      requirements_passed: ${{ steps.requirements-extract.outputs.passed }}
      requirements_summary: ${{ steps.requirements-extract.outputs.summary }}
      rules_passed: ${{ steps.rules-extract.outputs.passed }}
      rules_summary: ${{ steps.rules-extract.outputs.summary }}
      project_memory_passed: ${{ steps.project-memory-extract.outputs.passed }}
      project_memory_summary: ${{ steps.project-memory-extract.outputs.summary }}
      agents_passed: ${{ steps.agents-extract.outputs.passed }}
      agents_summary: ${{ steps.agents-extract.outputs.summary }}
      skills_passed: ${{ steps.skills-extract.outputs.passed }}
      skills_summary: ${{ steps.skills-extract.outputs.summary }}
      ui_passed: ${{ steps.ui-extract.outputs.passed }}
      ui_summary: ${{ steps.ui-extract.outputs.summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract context
        id: context
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Extract issue number from branch
          ISSUE_NUMBER=""
          if [[ $BRANCH_NAME =~ ^(feature|fix|bugfix|hotfix)/([0-9]+) ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[2]}"
          elif [[ $BRANCH_NAME =~ ^([0-9]+)- ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
          elif [[ $BRANCH_NAME =~ issue-([0-9]+) ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
          fi
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path' | tr '\n' ' ')
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | tr '\n' ' ' || echo "")
          fi
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" | tr ' ' '\n' > /tmp/changed_files.txt

      - name: Get issue context
        if: steps.context.outputs.issue_number != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.context.outputs.issue_number }}"
          gh issue view $ISSUE_NUM --json title,body,comments > /tmp/issue.json 2>/dev/null || echo "{}" > /tmp/issue.json

          ISSUE_TITLE=$(jq -r '.title // ""' /tmp/issue.json)
          ISSUE_BODY=$(jq -r '.body // ""' /tmp/issue.json)
          echo "$ISSUE_TITLE" > /tmp/issue_title.txt
          echo "$ISSUE_BODY" > /tmp/issue_body.txt
          jq -r '.comments[]?.body // ""' /tmp/issue.json > /tmp/issue_comments.txt 2>/dev/null || echo "" > /tmp/issue_comments.txt

      - name: Get PR context
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          gh pr view $PR_NUM --json comments,reviews > /tmp/pr_context.json 2>/dev/null || echo "{}" > /tmp/pr_context.json

          jq -r '.comments[]?.body // ""' /tmp/pr_context.json > /tmp/pr_comments.txt 2>/dev/null || echo "" > /tmp/pr_comments.txt
          jq -r '.reviews[]?.body // ""' /tmp/pr_context.json > /tmp/review_comments.txt 2>/dev/null || echo "" > /tmp/review_comments.txt

      # Requirements Review
      - name: Requirements Review
        id: requirements
        if: inputs.requirements_review
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "View,GlobTool,Grep,Bash(git diff:*),Bash(git log:*),Bash(cat:*)"
          max_turns: 15
          prompt: |
            # Requirements Review Agent

            Review code changes against linked issue requirements.

            ## Context
            - Branch: ${{ steps.context.outputs.branch_name }}
            - Issue: ${{ steps.context.outputs.issue_number }}
            - Changed Files: ${{ steps.context.outputs.changed_files }}

            ## Task
            1. Read issue context from /tmp/issue_title.txt, /tmp/issue_body.txt, /tmp/issue_comments.txt
            2. Read PR context from /tmp/pr_comments.txt, /tmp/review_comments.txt
            3. Review git diff for changed files
            4. Compare requirements vs implementation
            5. Output JSON with: passed, confidence, summary, requirements_met, requirements_missing

            Output MUST end with ```json block containing {passed, confidence, summary}.

      - name: Extract requirements result
        id: requirements-extract
        if: inputs.requirements_review
        run: |
          EXEC_FILE="${{ steps.requirements.outputs.execution_file }}"
          if [ -f "$EXEC_FILE" ]; then
            LAST_TEXT=$(jq -r '[.[] | select(.type == "assistant") | .message.content[]? | select(.type == "text") | .text] | last // ""' "$EXEC_FILE" 2>/dev/null)
            OUTPUT=$(echo "$LAST_TEXT" | sed -n '/```json/,/```/{/```json/d;/```/d;p;}' | tr -d '\r')
            if echo "$OUTPUT" | jq . >/dev/null 2>&1 && [ -n "$OUTPUT" ]; then
              echo "$OUTPUT" > /tmp/requirements_output.json
            else
              echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/requirements_output.json
            fi
          else
            echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/requirements_output.json
          fi

          echo "passed=$(jq -r '.passed // true' /tmp/requirements_output.json)" >> $GITHUB_OUTPUT
          echo "summary=$(jq -r '.summary // "No summary"' /tmp/requirements_output.json | head -c 200)" >> $GITHUB_OUTPUT

      # Rules Review
      - name: Rules Review
        id: rules
        if: inputs.rules_review
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "View,GlobTool,Grep,Bash(git diff:*),Bash(git log:*),Bash(cat:*),Bash(find:*)"
          max_turns: 20
          prompt: |
            # Rules Review Agent

            Review code changes against .claude/rules/*.md files.

            ## Context
            - Branch: ${{ steps.context.outputs.branch_name }}
            - Changed Files: Read /tmp/changed_files.txt

            ## Task
            1. Find all rules in .claude/rules/
            2. Match changed files to rules based on frontmatter path patterns
            3. Check compliance with matched rules
            4. Output JSON with: passed, confidence, summary, rule_evaluations

            Output MUST end with ```json block containing {passed, confidence, summary}.

      - name: Extract rules result
        id: rules-extract
        if: inputs.rules_review
        run: |
          EXEC_FILE="${{ steps.rules.outputs.execution_file }}"
          if [ -f "$EXEC_FILE" ]; then
            LAST_TEXT=$(jq -r '[.[] | select(.type == "assistant") | .message.content[]? | select(.type == "text") | .text] | last // ""' "$EXEC_FILE" 2>/dev/null)
            OUTPUT=$(echo "$LAST_TEXT" | sed -n '/```json/,/```/{/```json/d;/```/d;p;}' | tr -d '\r')
            if echo "$OUTPUT" | jq . >/dev/null 2>&1 && [ -n "$OUTPUT" ]; then
              echo "$OUTPUT" > /tmp/rules_output.json
            else
              echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/rules_output.json
            fi
          else
            echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/rules_output.json
          fi

          echo "passed=$(jq -r '.passed // true' /tmp/rules_output.json)" >> $GITHUB_OUTPUT
          echo "summary=$(jq -r '.summary // "No summary"' /tmp/rules_output.json | head -c 200)" >> $GITHUB_OUTPUT

      # Project Memory Review
      - name: Check memory files changed
        id: memory-filter
        run: |
          if grep -qE '(^|/)CLAUDE\.md$|^\.claude/' /tmp/changed_files.txt 2>/dev/null; then
            echo "has_memory_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_memory_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Project Memory Review
        id: project-memory
        if: inputs.project_memory_review && steps.memory-filter.outputs.has_memory_changes == 'true'
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "View,GlobTool,Grep,Bash(cat:*),Bash(find:*),Bash(git diff:*)"
          max_turns: 20
          prompt: |
            # Project Memory Review Agent

            Review changes to CLAUDE.md files for compliance.

            ## Context
            - Branch: ${{ steps.context.outputs.branch_name }}
            - Changed Files: Read /tmp/changed_files.txt

            ## Task
            1. Find relevant CLAUDE.md files
            2. Check changes comply with documented rules
            3. Identify if updates are needed based on issue context
            4. Output JSON with: passed, confidence, summary

            Output MUST end with ```json block containing {passed, confidence, summary}.

      - name: Extract project memory result
        id: project-memory-extract
        if: inputs.project_memory_review && steps.memory-filter.outputs.has_memory_changes == 'true'
        run: |
          EXEC_FILE="${{ steps.project-memory.outputs.execution_file }}"
          if [ -f "$EXEC_FILE" ]; then
            LAST_TEXT=$(jq -r '[.[] | select(.type == "assistant") | .message.content[]? | select(.type == "text") | .text] | last // ""' "$EXEC_FILE" 2>/dev/null)
            OUTPUT=$(echo "$LAST_TEXT" | sed -n '/```json/,/```/{/```json/d;/```/d;p;}' | tr -d '\r')
            if echo "$OUTPUT" | jq . >/dev/null 2>&1 && [ -n "$OUTPUT" ]; then
              echo "$OUTPUT" > /tmp/project_memory_output.json
            else
              echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/project_memory_output.json
            fi
          else
            echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/project_memory_output.json
          fi

          echo "passed=$(jq -r '.passed // true' /tmp/project_memory_output.json)" >> $GITHUB_OUTPUT
          echo "summary=$(jq -r '.summary // "No summary"' /tmp/project_memory_output.json | head -c 200)" >> $GITHUB_OUTPUT

      # Agents Review
      - name: Check agent files changed
        id: agents-filter
        run: |
          if grep -qE '(agents/.*\.md|AGENT\.md)' /tmp/changed_files.txt 2>/dev/null; then
            echo "has_agent_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_agent_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Agents Review
        id: agents
        if: inputs.agents_review && steps.agents-filter.outputs.has_agent_changes == 'true'
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "View,GlobTool,Grep,Bash(cat:*),Bash(find:*)"
          max_turns: 15
          prompt: |
            # Agents Review Agent

            Review .claude/agents/*.md files for quality and context optimization.

            ## Context
            - Changed Files: Read /tmp/changed_files.txt

            ## Task
            1. Read changed agent files
            2. Check frontmatter requirements
            3. Evaluate context efficiency, clarity, focus
            4. Output JSON with: passed, confidence, summary, agent_evaluations

            Output MUST end with ```json block containing {passed, confidence, summary}.

      - name: Extract agents result
        id: agents-extract
        if: inputs.agents_review && steps.agents-filter.outputs.has_agent_changes == 'true'
        run: |
          EXEC_FILE="${{ steps.agents.outputs.execution_file }}"
          if [ -f "$EXEC_FILE" ]; then
            LAST_TEXT=$(jq -r '[.[] | select(.type == "assistant") | .message.content[]? | select(.type == "text") | .text] | last // ""' "$EXEC_FILE" 2>/dev/null)
            OUTPUT=$(echo "$LAST_TEXT" | sed -n '/```json/,/```/{/```json/d;/```/d;p;}' | tr -d '\r')
            if echo "$OUTPUT" | jq . >/dev/null 2>&1 && [ -n "$OUTPUT" ]; then
              echo "$OUTPUT" > /tmp/agents_output.json
            else
              echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/agents_output.json
            fi
          else
            echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/agents_output.json
          fi

          echo "passed=$(jq -r '.passed // true' /tmp/agents_output.json)" >> $GITHUB_OUTPUT
          echo "summary=$(jq -r '.summary // "No summary"' /tmp/agents_output.json | head -c 200)" >> $GITHUB_OUTPUT

      # Skills Review
      - name: Check skill files changed
        id: skills-filter
        run: |
          if grep -qE '(skills/.*\.md|SKILL\.md)' /tmp/changed_files.txt 2>/dev/null; then
            echo "has_skill_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_skill_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Skills Review
        id: skills
        if: inputs.skills_review && steps.skills-filter.outputs.has_skill_changes == 'true'
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "View,GlobTool,Grep,Bash(cat:*),Bash(find:*)"
          max_turns: 15
          prompt: |
            # Skills Review Agent

            Review .claude/skills/**/SKILL.md files for quality and context efficiency.

            ## Context
            - Changed Files: Read /tmp/changed_files.txt

            ## Task
            1. Read changed skill files
            2. Check frontmatter requirements
            3. Evaluate context efficiency, structure, documentation links
            4. Output JSON with: passed, confidence, summary, skill_evaluations

            Output MUST end with ```json block containing {passed, confidence, summary}.

      - name: Extract skills result
        id: skills-extract
        if: inputs.skills_review && steps.skills-filter.outputs.has_skill_changes == 'true'
        run: |
          EXEC_FILE="${{ steps.skills.outputs.execution_file }}"
          if [ -f "$EXEC_FILE" ]; then
            LAST_TEXT=$(jq -r '[.[] | select(.type == "assistant") | .message.content[]? | select(.type == "text") | .text] | last // ""' "$EXEC_FILE" 2>/dev/null)
            OUTPUT=$(echo "$LAST_TEXT" | sed -n '/```json/,/```/{/```json/d;/```/d;p;}' | tr -d '\r')
            if echo "$OUTPUT" | jq . >/dev/null 2>&1 && [ -n "$OUTPUT" ]; then
              echo "$OUTPUT" > /tmp/skills_output.json
            else
              echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/skills_output.json
            fi
          else
            echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/skills_output.json
          fi

          echo "passed=$(jq -r '.passed // true' /tmp/skills_output.json)" >> $GITHUB_OUTPUT
          echo "summary=$(jq -r '.summary // "No summary"' /tmp/skills_output.json | head -c 200)" >> $GITHUB_OUTPUT

      # UI Review
      - name: Check UI files changed
        id: ui-filter
        run: |
          if grep -qE '\.(tsx|css|scss)$' /tmp/changed_files.txt 2>/dev/null; then
            echo "has_ui_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_ui_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Download screenshots
        if: inputs.playwright_ui_review && steps.ui-filter.outputs.has_ui_changes == 'true' && inputs.screenshot_artifact != ''
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.screenshot_artifact }}
          path: .claude/screenshots/
        continue-on-error: true

      - name: UI Review
        id: ui
        if: inputs.playwright_ui_review && steps.ui-filter.outputs.has_ui_changes == 'true'
        uses: anthropics/claude-code-base-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_tools: "View,GlobTool,Grep,Bash(cat:*),Bash(find:*),Bash(ls:*)"
          max_turns: 25
          model: claude-sonnet-4-5-20250929
          prompt: |
            # Playwright UI Review Agent

            Review UI screenshots against best practices.

            ## Context
            - Screenshots: Check .claude/screenshots/
            - Changed Files: Read /tmp/changed_files.txt

            ## Task
            1. View screenshots in .claude/screenshots/
            2. Evaluate visual design, layout, accessibility, UX, elegance
            3. Identify critical/major/minor issues
            4. Output JSON with: passed, confidence, summary, best_practices_evaluation

            Output MUST end with ```json block containing {passed, confidence, summary}.

      - name: Extract UI result
        id: ui-extract
        if: inputs.playwright_ui_review && steps.ui-filter.outputs.has_ui_changes == 'true'
        run: |
          EXEC_FILE="${{ steps.ui.outputs.execution_file }}"
          if [ -f "$EXEC_FILE" ]; then
            LAST_TEXT=$(jq -r '[.[] | select(.type == "assistant") | .message.content[]? | select(.type == "text") | .text] | last // ""' "$EXEC_FILE" 2>/dev/null)
            OUTPUT=$(echo "$LAST_TEXT" | sed -n '/```json/,/```/{/```json/d;/```/d;p;}' | tr -d '\r')
            if echo "$OUTPUT" | jq . >/dev/null 2>&1 && [ -n "$OUTPUT" ]; then
              echo "$OUTPUT" > /tmp/ui_output.json
            else
              echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/ui_output.json
            fi
          else
            echo '{"passed":true,"confidence":0.8,"summary":"Review completed"}' > /tmp/ui_output.json
          fi

          echo "passed=$(jq -r '.passed // true' /tmp/ui_output.json)" >> $GITHUB_OUTPUT
          echo "summary=$(jq -r '.summary // "No summary"' /tmp/ui_output.json | head -c 200)" >> $GITHUB_OUTPUT

  post-comment:
    name: Post Review Summary
    needs: reviews
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Consolidate and post comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REQ_PASSED="${{ needs.reviews.outputs.requirements_passed }}"
          REQ_SUMMARY="${{ needs.reviews.outputs.requirements_summary }}"
          RULES_PASSED="${{ needs.reviews.outputs.rules_passed }}"
          RULES_SUMMARY="${{ needs.reviews.outputs.rules_summary }}"
          MEMORY_PASSED="${{ needs.reviews.outputs.project_memory_passed }}"
          MEMORY_SUMMARY="${{ needs.reviews.outputs.project_memory_summary }}"
          AGENTS_PASSED="${{ needs.reviews.outputs.agents_passed }}"
          AGENTS_SUMMARY="${{ needs.reviews.outputs.agents_summary }}"
          SKILLS_PASSED="${{ needs.reviews.outputs.skills_passed }}"
          SKILLS_SUMMARY="${{ needs.reviews.outputs.skills_summary }}"
          UI_PASSED="${{ needs.reviews.outputs.ui_passed }}"
          UI_SUMMARY="${{ needs.reviews.outputs.ui_summary }}"

          # Determine overall status
          OVERALL_PASS=true
          if [[ "$REQ_PASSED" == "false" ]] || [[ "$RULES_PASSED" == "false" ]] || \
             [[ "$MEMORY_PASSED" == "false" ]] || [[ "$AGENTS_PASSED" == "false" ]] || \
             [[ "$SKILLS_PASSED" == "false" ]] || [[ "$UI_PASSED" == "false" ]]; then
            OVERALL_PASS=false
          fi

          # Build status icon function
          get_icon() {
            case "$1" in
              true) echo ":white_check_mark:" ;;
              false) echo ":x:" ;;
              *) echo ":white_circle:" ;;
            esac
          }

          if [ "$OVERALL_PASS" = "true" ]; then
            OVERALL_ICON=":white_check_mark:"
            OVERALL_STATUS="All Reviews Passed"
          else
            OVERALL_ICON=":x:"
            OVERALL_STATUS="Some Reviews Failed"
          fi

          COMMENT="## Code Reviews Summary ${OVERALL_ICON}

          **Status:** ${OVERALL_STATUS}
          **Commit:** \`${{ github.sha }}\`

          ### Reviews
          | Review | Status | Summary |
          |--------|--------|---------|
          | Requirements | $(get_icon $REQ_PASSED) | ${REQ_SUMMARY:-Skipped} |
          | Rules | $(get_icon $RULES_PASSED) | ${RULES_SUMMARY:-Skipped} |
          | Project Memory | $(get_icon $MEMORY_PASSED) | ${MEMORY_SUMMARY:-Skipped} |
          | Agents | $(get_icon $AGENTS_PASSED) | ${AGENTS_SUMMARY:-Skipped} |
          | Skills | $(get_icon $SKILLS_PASSED) | ${SKILLS_SUMMARY:-Skipped} |
          | UI | $(get_icon $UI_PASSED) | ${UI_SUMMARY:-Skipped} |

          ---
          *Automated Code Reviews by Claude Code*
          [View Full Run](/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          # Find and update existing comment or create new one
          COMMENT_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            --jq '.[] | select(.body | contains("Code Reviews Summary")) | .id' | head -1)

          if [ -n "$COMMENT_ID" ]; then
            gh api \
              -X PATCH \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
              -f body="$COMMENT"
          else
            gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT"
          fi

  summary:
    name: Reviews Summary
    needs: [reviews, post-comment]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      all_passed: ${{ steps.check.outputs.all_passed }}

    steps:
      - name: Check results
        id: check
        run: |
          REQ="${{ needs.reviews.outputs.requirements_passed }}"
          RULES="${{ needs.reviews.outputs.rules_passed }}"
          MEMORY="${{ needs.reviews.outputs.project_memory_passed }}"
          AGENTS="${{ needs.reviews.outputs.agents_passed }}"
          SKILLS="${{ needs.reviews.outputs.skills_passed }}"
          UI="${{ needs.reviews.outputs.ui_passed }}"

          echo "Requirements: $REQ"
          echo "Rules: $RULES"
          echo "Project Memory: $MEMORY"
          echo "Agents: $AGENTS"
          echo "Skills: $SKILLS"
          echo "UI: $UI"

          # Fail if any review explicitly failed
          if [[ "$REQ" == "false" ]] || [[ "$RULES" == "false" ]] || \
             [[ "$MEMORY" == "false" ]] || [[ "$AGENTS" == "false" ]] || \
             [[ "$SKILLS" == "false" ]] || [[ "$UI" == "false" ]]; then
            echo "all_passed=false" >> $GITHUB_OUTPUT
            echo "::error::One or more reviews failed"
            exit 1
          fi

          echo "all_passed=true" >> $GITHUB_OUTPUT
          echo "All reviews passed or skipped"
